@model WeddingShare.Models.PhotoGallery

@using WeddingShare.Constants
@using WeddingShare.Views.Gallery.Modes

@{
    var slideshowInterval = TimeSpan.FromSeconds(await _settings.GetOrDefault(Settings.Slideshow.Interval, 10)).TotalMilliseconds;
    var slideshowFade = await _settings.GetOrDefault(Settings.Slideshow.Fade, 500);
    var slideLimit = await _settings.GetOrDefault(Settings.Slideshow.Limit, int.MaxValue);
    var identityEnabled = await _settings.GetOrDefault(Settings.IdentityCheck.Enabled, true);

    if (Model?.Images != null)
    {
        <div class="slideshow col-12">
            @foreach (var image in Model.Images.Take(slideLimit))
            {
                <div class="slideshow-slide">
                    <img src="@image.ImagePath" class="slideshow-slide-img shadow-1-strong" loading="lazy" />
                    @if (identityEnabled)
                    {
                        <h6 class="credits">@_localizer["Uploaded_By"].Value: @(!string.IsNullOrWhiteSpace(image?.UploadedBy) ? image.UploadedBy : "Anonymous")</h6>
                    }
                </div>
            }

            @if (await _settings.GetOrDefault(Settings.Slideshow.IncludeShareSlide, true))
            {
                <div class="slideshow-slide">
                    <span class="slideshow-slide-img share-slide"></span>
                    <h6 class="credits">@_localizer["Scan_To_Share"].Value</h6>
                </div>
            }
        </div>
    }
}

@if (Model?.LoadScripts ?? true)
{
    <div id="danmaku-container" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; z-index: 9999;"></div>

    <style>
        .danmaku-item {
            position: absolute;
            white-space: nowrap;
            font-size: 36px;
            font-weight: bold;
            opacity: 0.95;
            animation: danmaku-move linear forwards;
            left: 100%;
            pointer-events: none;
            text-shadow: 
                3px 3px 0 rgba(0, 0, 0, 0.9),
                -2px -2px 0 rgba(0, 0, 0, 0.9),
                2px -2px 0 rgba(0, 0, 0, 0.9),
                -2px 2px 0 rgba(0, 0, 0, 0.9),
                0 0 8px rgba(0, 0, 0, 0.7),
                0 0 16px rgba(0, 0, 0, 0.5);
        }

        /* 多彩顏色樣式 */
        .danmaku-gold {
            color: #FFD700;
        }
        
        .danmaku-pink {
            color: #FF69B4;
        }
        
        .danmaku-cyan {
            color: #00FFFF;
        }
        
        .danmaku-white {
            color: #FFFFFF;
        }
        
        .danmaku-lime {
            color: #00FF00;
        }

        @keyframes danmaku-move {
            from {
                transform: translateX(0);
            }
            to {
                transform: translateX(-120vw);
            }
        }
    </style>

    <script src="~/lib/signalr/signalr.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () { 
            $(function () {

                // Danmaku Logic
                if (!window.danmakuConnection) {
                    // 彈幕軌道管理
                    const LANE_COUNT = 8;
                    const LANE_HEIGHT = 100 / LANE_COUNT;
                    const laneLastUsed = new Array(LANE_COUNT).fill(0);
                    
                    // 彈幕顏色樣式
                    const danmakuColors = ['danmaku-gold', 'danmaku-pink', 'danmaku-cyan', 'danmaku-white', 'danmaku-lime'];
                    
                    function getAvailableLane() {
                        const now = Date.now();
                        let bestLane = 0;
                        let longestIdle = 0;
                        
                        for (let i = 0; i < LANE_COUNT; i++) {
                            const idleTime = now - laneLastUsed[i];
                            if (idleTime > longestIdle) {
                                longestIdle = idleTime;
                                bestLane = i;
                            }
                        }
                        
                        laneLastUsed[bestLane] = now;
                        return bestLane;
                    }

                    window.danmakuConnection = new signalR.HubConnectionBuilder()
                        .withUrl("/danmakuHub")
                        .withAutomaticReconnect()
                        .build();

                    window.danmakuConnection.on("ReceiveMessage", function (message) {
                        var container = $('#danmaku-container');
                        if (container.length === 0) return;

                        // 隨機選擇顏色
                        var colorClass = danmakuColors[Math.floor(Math.random() * danmakuColors.length)];
                        var item = $('<div class="danmaku-item ' + colorClass + '"></div>').text(message);
                        
                        // 使用軌道系統防止重疊
                        var lane = getAvailableLane();
                        var topPercent = lane * LANE_HEIGHT + (LANE_HEIGHT / 2) - 2;
                        item.css('top', topPercent + '%');
                        
                        // 隨機速度 (6-12秒)
                        var duration = 6 + Math.random() * 6; 
                        item.css('animation-duration', duration + 's');

                        container.append(item);

                        // 動畫結束後移除
                        setTimeout(function() {
                            item.remove();
                        }, duration * 1000 + 500);
                    });

                    window.danmakuConnection.start().then(function () {
                        console.log("Danmaku Connected");
                        window.danmakuConnection.invoke("JoinGroup", "@Model?.Gallery?.Id");
                    }).catch(function (err) {
                        return console.error(err.toString());
                    });
                } else if (window.danmakuConnection.state === signalR.HubConnectionState.Connected) {
                     window.danmakuConnection.invoke("JoinGroup", "@Model?.Gallery?.Id");
                }


                var slidetimer = null;
                var transitionTimer = null;
                var resizeTimeout = null;

                $(window).on('resize', function () {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(function () {
                        init();
                    }, 200);
                });

                function init() {
                    var windowHeight = $(window).outerHeight();
                    var headerHeight = $('.navbar').outerHeight();
                    var footerHeight = $('footer').outerHeight();
                    var creditsHeight = $('.credits').length > 0 ? 20 : 0;
                    var reviewCounterHeight = $('.review-counter').length > 0 ? $('.review-counter').outerHeight() + 70 : 50;
                    var slideHeight = windowHeight - (headerHeight + footerHeight + reviewCounterHeight + creditsHeight);

                    $('.slideshow .slideshow-slide .share-slide').qrcode({ width: slideHeight, height: slideHeight, text: '@Html.Raw(ViewBag.QRCodeLink)' });

                    $('.slideshow').height(slideHeight);
                    $('.slideshow .slideshow-slide').each(function (index) {
                        $(this).attr('data-slide-index', index);
                    });
                    $('.slideshow .slideshow-slide[data-slide-index="0"]').show();

                    var currentSlide = 0;
                    var fadeInterval = @slideshowFade;
                    clearInterval(slidetimer);
                    slidetimer = setInterval(function () {
                        currentSlide++;

                        if (currentSlide >= $('.slideshow .slideshow-slide').length) {
                            $.ajax({
                                type: 'GET',
                                url: `${window.location.pathname}${window.location.search}&partial=true`,
                                success: function (data) {
                                    clearInterval(slidetimer);
                                    clearTimeout(transitionTimer);
                                    $('#main-gallery').html(data);
                                    init();
                                }
                            });
                        }

                        $('.slideshow-slide').fadeOut(fadeInterval);
                        clearTimeout(transitionTimer);
                        transitionTimer = setTimeout(function () {
                            $(`.slideshow-slide[data-slide-index="${currentSlide}"]`).fadeIn(fadeInterval);
                        }, fadeInterval);
                    }, @slideshowInterval);
                }
                init();

            });
        }, false);
    </script>
}